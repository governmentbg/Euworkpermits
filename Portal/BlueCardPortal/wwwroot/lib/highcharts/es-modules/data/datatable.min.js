"use strict";import U from"../Core/Utilities.js";const{addEvent,fireEvent,uniqueKey}=U;class DataTable{static isNull(s){if(s===DataTable.NULL)return!0;if(s instanceof Array){if(!s.length)return!1;for(let e=0,t=s.length;e<t;++e)if(null!==s[e])return!1}else{var o=Object.keys(s);if(!o.length)return!1;for(let e=0,t=o.length;e<t;++e)if(null!==s[o[e]])return!1}return!0}constructor(e={}){this.aliases=e.aliases?JSON.parse(JSON.stringify(e.aliases)):{},this.autoId=!e.id,this.columns={},this.id=e.id||uniqueKey(),(this.modified=this).rowCount=0,this.versionTag=uniqueKey(),this.rowKeysId=e.rowKeysId;const i=e.columns||{},r=Object.keys(i),l=this.columns;let n=0;for(let e=0,t=r.length,s,o;e<t;++e)o=r[e],s=i[o].slice(),l[o]=s,n=Math.max(n,s.length);for(let e=0,t=r.length;e<t;++e)l[r[e]].length=n;this.rowCount=n;const o=e.aliases||{},a=Object.keys(o),u=this.aliases;for(let e=0,t=a.length,s;e<t;++e)s=a[e],u[s]=o[s];this.setRowKeysColumn(n)}clone(e,t){const s=this,o={},i=(s.emit({type:"cloneTable",detail:t}),e||(o.aliases=s.aliases,o.columns=s.columns),s.autoId||(o.id=s.id),s.rowKeysId&&(o.rowKeysId=s.rowKeysId),new DataTable(o));return e||(i.versionTag=s.versionTag),s.emit({type:"afterCloneTable",detail:t,tableClone:i}),i}deleteColumnAlias(e){const t=this,s=t.aliases,o=s[e],i=t.modifier;return o&&(delete t.aliases[e],i&&i.modifyColumns(t,{[o]:new Array(t.rowCount)},0)),o}deleteColumns(i,t){const s=this,r=s.columns,l={},n={},o=s.modifier,a=s.rowCount;if((i=i||Object.keys(r)).length){s.emit({type:"deleteColumns",columnNames:i,detail:t});for(let e=0,t=i.length,s,o;e<t;++e)o=i[e],(s=r[o])&&(l[o]=s,n[o]=new Array(a)),delete r[o];let e=Object.keys(r).length;return s.rowKeysId&&1===e&&(delete r[s.rowKeysId],e=0),e||(s.rowCount=0),o&&o.modifyColumns(s,n,0,t),s.emit({type:"afterDeleteColumns",columns:l,columnNames:i,detail:t}),l}}deleteRows(i,r=1,e){const l=this,n=[],a=[],t=l.modifier;if(l.emit({type:"deleteRows",detail:e,rowCount:r,rowIndex:i||0}),void 0===i&&(i=0,r=l.rowCount),0<r&&i<l.rowCount){var u=l.columns,m=Object.keys(u);for(let s=0,e=m.length,t,o;s<e;++s){o=(t=u[m[s]]).splice(i,r),s||(l.rowCount=t.length);for(let e=0,t=o.length;e<t;++e)n[e]=n[e]||[],n[e][s]=o[e];a.push(new Array(e))}}return t&&t.modifyRows(l,a,i||0,e),l.emit({type:"afterDeleteRows",detail:e,rowCount:r,rowIndex:i||0,rows:n}),n}emit(e){switch(e.type){case"afterDeleteColumns":case"afterDeleteRows":case"afterSetCell":case"afterSetColumns":case"afterSetRows":this.versionTag=uniqueKey()}fireEvent(this,e.type,e)}getCell(e,t){e=this.aliases[e]||e;e=this.columns[e];if(e)return e[t]}getCellAsBoolean(e,t){e=this.aliases[e]||e;e=this.columns[e];return!(!e||!e[t])}getCellAsNumber(e,t,s){e=this.aliases[e]||e;e=this.columns[e];let o=e&&e[t];switch(typeof o){case"boolean":return o?1:0;case"number":return isNaN(o)&&!s?null:o}return o=parseFloat(""+(o??"")),isNaN(o)&&!s?null:o}getCellAsString(e,t){e=this.aliases[e]||e;e=this.columns[e];return""+(e&&e[t])}getColumn(e,t){return this.getColumns([e],t)[e]}getColumnAsNumbers(t,e){const s=this.columns[t=this.aliases[t]||t],o=[];if(s){var i=s.length;if(e)for(let e=0;e<i;++e)o.push(this.getCellAsNumber(t,e,!0));else{for(let e=0,t;e<i;++e){if("number"==typeof(t=s[e]))return s.slice();if(null!=t)break}for(let e=0;e<i;++e)o.push(this.getCellAsNumber(t,e))}}return o}getColumnNames(){var e=Object.keys(this.columns);return this.removeRowKeysColumn(e),e}getColumns(i,r){const l=this.aliases,n=this.columns,a={};i=i||Object.keys(n),this.removeRowKeysColumn(i);for(let e=0,t=i.length,s,o;e<t;++e)o=i[e],(s=n[l[o]||o])&&(a[o]=r?s:s.slice());return a}getModifier(){return this.modifier}getRow(e,t){return this.getRows(e,1,t)[0]}getRowCount(){return this.rowCount}getRowIndexBy(e,t,s){e=this.aliases[e]||e;const o=this.columns[e];if(o){e=o.indexOf(t,s);if(-1!==e)return e}}getRowObject(e,t){return this.getRowObjects(e,1,t)[0]}getRowObjects(r=0,l=this.rowCount-r,n){const a=this.aliases,u=this.columns,m=new Array(l);n=n||Object.keys(u),this.removeRowKeysColumn(n);for(let e=r,t=0,s=Math.min(this.rowCount,r+l),o,i;e<s;++e,++t){i=m[t]={};for(const h of n)o=u[a[h]||h],i[h]=o?o[e]:void 0}return m}getRows(r=0,l=this.rowCount-r,n){const a=this.aliases,u=this.columns,m=new Array(l);n=n||Object.keys(u);for(let e=r,t=0,s=Math.min(this.rowCount,r+l),o,i;e<s;++e,++t){i=m[t]=[];for(const h of n)o=u[a[h]||h],i.push(o?o[e]:void 0)}return m}getVersionTag(){return this.versionTag}hasColumns(o){var i=this.aliases,r=this.columns;for(let e=0,t=o.length,s;e<t;++e)if(!r[s=o[e]]&&!i[s])return!1;return!0}hasRowWith(e,t){e=this.aliases[e]||e;const s=this.columns[e];return!!s&&-1!==s.indexOf(t)}on(e,t){return addEvent(this,e,t)}renameColumn(e,t){const s=this.columns;if(s[e]){if(e!==t){const o=this.aliases;o[t]&&delete o[t],s[t]=s[e],delete s[e],this.rowKeysId&&this.moveRowKeysColumnToLast(s,this.rowKeysId)}return!0}return!1}setCell(e,t,s,o){const i=this,r=i.columns,l=i.modifier;e=i.aliases[e]||e;let n=r[e];n&&n[t]===s||(i.emit({type:"setCell",cellValue:s,columnName:e,detail:o,rowIndex:t}),n=n||(r[e]=new Array(i.rowCount)),t>=i.rowCount&&(i.rowCount=t+1),n[t]=s,l&&l.modifyCell(i,e,t,s),i.emit({type:"afterSetCell",cellValue:s,columnName:e,detail:o,rowIndex:t}))}setColumn(e,t=[],s=0,o){this.setColumns({[e]:t},s,o)}setColumns(i,r,e){const l=this,n=l.columns,t=l.modifier,a=void 0===r,u=Object.keys(i);l.emit({type:"setColumns",columns:i,columnNames:u,detail:e,rowIndex:r});for(let e=0,t=u.length,s,o;e<t;++e)if(o=u[e],s=i[o],o=l.aliases[o]||o,a)n[o]=s.slice(),l.rowCount=s.length;else{const m=n[o]||(n[o]=new Array(l.rowCount));for(let e=r||0,t=s.length;e<t;++e)m[e]=s[e];l.rowCount=Math.max(l.rowCount,m.length)}var s=Object.keys(n);for(let e=0,t=s.length;e<t;++e)n[s[e]].length=l.rowCount;t&&t.modifyColumns(l,i,r||0),l.rowKeysId&&this.moveRowKeysColumnToLast(n,l.rowKeysId),l.emit({type:"afterSetColumns",columns:i,columnNames:u,detail:e,rowIndex:r})}setRowKeysColumn(t){var s=this.rowKeysId;if(s){this.columns[s]=[];const o=this.columns[s];for(let e=0;e<t;e++)o.push(s+"_"+e)}}getRowKeysColumn(){var e=this.rowKeysId;if(e)return this.columns[e]}getRowIndexOriginal(e){var t=this.rowKeysId;if(t){const s=""+this.columns[t][e];return s.split("_")[1]}return String(e)}setModifier(t,s){const o=this;let e;return o.emit({type:"setModifier",detail:s,modifier:t,modified:o.modified}),(o.modified=o).modifier=t,(e=t?t.modify(o):Promise.resolve(o)).then(e=>(e.emit({type:"afterSetModifier",detail:s,modifier:t,modified:e.modified}),e)).catch(e=>{throw o.emit({type:"setModifierError",error:e,modifier:t,modified:o.modified}),e})}setRow(e,t,s){this.setRows([e],t,s)}setRows(t,s=this.rowCount,e){const o=this,r=o.aliases,l=o.columns,n=Object.keys(l),i=o.modifier,a=t.length;o.emit({type:"setRows",detail:e,rowCount:a,rowIndex:s,rows:t});for(let e=0,o=s,i;e<a;++e,++o)if((i=t[e])===DataTable.NULL)for(let e=0,t=n.length;e<t;++e)l[n[e]][o]=null;else if(i instanceof Array)for(let e=0,t=n.length;e<t;++e)l[n[e]][o]=i[e];else{var u=Object.keys(i);for(let e=0,t=u.length,s;e<t;++e)s=r[s=u[e]]||s,l[s]||(l[s]=new Array(o+1)),l[s][o]=i[s]}var m=s+a;if(m>o.rowCount){o.rowCount=m;for(let e=0,t=n.length;e<t;++e)l[n[e]].length=m}this.rowKeysId&&!n.includes(this.rowKeysId)&&this.setRowKeysColumn(a),i&&i.modifyRows(o,t,s),o.emit({type:"afterSetRows",detail:e,rowCount:a,rowIndex:s,rows:t})}moveRowKeysColumnToLast(e,t){var s=e[t];delete e[t],e[t]=s}removeRowKeysColumn(e){this.rowKeysId&&-1!==e.indexOf(this.rowKeysId)&&e.pop()}}DataTable.NULL={},DataTable.version="1.0.0";export default DataTable;