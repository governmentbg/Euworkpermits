"use strict";import Chart from"../Core/Chart/Chart.js";import D from"../Core/Defaults.js";const getOptions=D["getOptions"];import G from"../Core/Globals.js";const doc=G["doc"];import HU from"../Core/HttpUtilities.js";const ajax=HU["ajax"];import Point from"../Core/Series/Point.js";import SeriesRegistry from"../Core/Series/SeriesRegistry.js";const seriesTypes=SeriesRegistry["seriesTypes"];import U from"../Core/Utilities.js";const{addEvent,defined,extend,fireEvent,isNumber,merge,objectEach,pick,splat}=U;function getFreeIndexes(e,t){const s=[],r=[];let i,o,a;for(o=0;o<e;o+=1)s.push(!0);for(i=0;i<t.length;i+=1)for(a=t[i].getReferencedColumnIndexes(),o=0;o<a.length;o+=1)s[a[o]]=!1;for(o=0;o<s.length;o+=1)s[o]&&r.push(o);return r}function hasURLOption(e){return Boolean(e&&(e.rowsURL||e.csvURL||e.columnsURL))}class Data{static data(e,t={},s){return new Data(e,t,s)}static rowsToColumns(e){let t,s,r,i,o;if(e)for(o=[],s=e.length,t=0;t<s;t++)for(i=e[t].length,r=0;r<i;r++)o[r]||(o[r]=[]),o[r][t]=e[t][r];return o}constructor(e,t={},s){this.rowsToColumns=Data.rowsToColumns,this.dateFormats={"YYYY/mm/dd":{regex:/^(\d{4})[\-\/\.](\d{1,2})[\-\/\.](\d{1,2})$/,parser:function(e){return e?Date.UTC(+e[1],e[2]-1,+e[3]):NaN}},"dd/mm/YYYY":{regex:/^(\d{1,2})[\-\/\.](\d{1,2})[\-\/\.](\d{4})$/,parser:function(e){return e?Date.UTC(+e[3],e[2]-1,+e[1]):NaN},alternative:"mm/dd/YYYY"},"mm/dd/YYYY":{regex:/^(\d{1,2})[\-\/\.](\d{1,2})[\-\/\.](\d{4})$/,parser:function(e){return e?Date.UTC(+e[3],e[1]-1,+e[2]):NaN}},"dd/mm/YY":{regex:/^(\d{1,2})[\-\/\.](\d{1,2})[\-\/\.](\d{2})$/,parser:function(e){if(!e)return NaN;const t=new Date;let s=+e[3];return s>t.getFullYear()-2e3?s+=1900:s+=2e3,Date.UTC(s,e[2]-1,+e[1])},alternative:"mm/dd/YY"},"mm/dd/YY":{regex:/^(\d{1,2})[\-\/\.](\d{1,2})[\-\/\.](\d{2})$/,parser:function(e){return e?Date.UTC(+e[3]+2e3,e[1]-1,+e[2]):NaN}}},this.chart=s,this.chartOptions=t,this.options=e,this.rawColumns=[],this.init(e,t,s)}init(e,t,s){let r=e.decimalPoint,i;t&&(this.chartOptions=t),s&&(this.chart=s),"."!==r&&","!==r&&(r=void 0),this.options=e,this.columns=e.columns||this.rowsToColumns(e.rows)||[],this.firstRowAsNames=pick(e.firstRowAsNames,this.firstRowAsNames,!0),this.decimalRegex=r&&new RegExp("^(-?[0-9]+)"+r+"([0-9]+)$"),void 0!==this.liveDataTimeout&&clearTimeout(this.liveDataTimeout),this.rawColumns=[],this.columns.length&&(this.dataFound(),i=!hasURLOption(e)),!(i=(i=(i=(i=i||this.fetchLiveData())||Boolean(this.parseCSV().length))||Boolean(this.parseTable().length))||this.parseGoogleSpreadsheet())&&e.afterComplete&&e.afterComplete()}getColumnDistribution(){function n(e){return(seriesTypes[e||"line"].prototype.pointArrayMap||[0]).length}function l(e){return seriesTypes[e||"line"].prototype.pointArrayMap}const d=this.chartOptions,e=this.options,t=[],h=d&&d.chart&&d.chart.type,u=[],m=[],s=e&&e.seriesMapping||d&&d.series&&d.series.map(function(){return{x:0}})||[];let c=0,p,r=((d&&d.series||[]).forEach(e=>{u.push(n(e.type||h))}),s.forEach(e=>{t.push(e.x||0)}),0===t.length&&t.push(0),s.forEach(e=>{const s=new SeriesBuilder,t=u[c]||n(h),r=d&&d.series||[],i=r[c]||{},o=l(i.type||h),a=o||["y"];for(!defined(e.x)&&!i.isCartesian&&o||s.addColumnReader(e.x,"x"),objectEach(e,function(e,t){"x"!==t&&s.addColumnReader(e,t)}),p=0;p<t;p++)s.hasReader(a[p])||s.addColumnReader(void 0,a[p]);m.push(s),c++}),l(h));void 0===r&&(r=["y"]),this.valueCount={global:n(h),xColumns:t,individual:u,seriesBuilders:m,globalPointArrayMap:r}}dataFound(){this.options.switchRowsAndColumns&&(this.columns=this.rowsToColumns(this.columns)),this.getColumnDistribution(),this.parseTypes(),!1!==this.parsed()&&this.complete()}parseCSV(e){const u=this,p=this.columns=[],f=e||this.options,g=void 0!==f.startColumn&&f.startColumn?f.startColumn:0,C=f.endColumn||Number.MAX_VALUE,x=[],d={",":0,";":0,"\t":0};let t=f.csv,s=void 0!==f.startRow&&f.startRow?f.startRow:0,r=f.endRow||Number.MAX_VALUE,v,i,o=0;if(t=t&&f.beforeParse?f.beforeParse.call(this,t):t){i=t.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split(f.lineDelimiter||"\n"),(!s||s<0)&&(s=0),(!r||r>=i.length)&&(r=i.length-1),v=f.itemDelimiter||(v=null,function(e){let n=0,l=0,t=!1;return e.some(function(t,e){let s=!1,r,i,o,a="";if(13<e)return!0;for(let e=0;e<t.length;e++){if(r=t[e],i=t[e+1],o=t[e-1],"#"===r)return;if('"'===r)if(s){if('"'!==o&&'"'!==i){for(;" "===i&&e<t.length;)i=t[++e];void 0!==d[i]&&d[i]++,s=!1}}else s=!0;else void 0!==d[r]?(a=a.trim(),isNaN(Date.parse(a))&&!isNaN(a)&&isFinite(a)||d[r]++,a=""):a+=r;","===r&&l++,"."===r&&n++}}),t=d[";"]>d[","]?";":(d[","],d[";"],","),f.decimalPoint||(n>l?f.decimalPoint=".":f.decimalPoint=",",u.decimalRegex=new RegExp("^(-?[0-9]+)"+f.decimalPoint+"([0-9]+)$")),t}(i));let e=0;for(o=s;o<=r;o++)"#"===i[o][0]?e++:function(t,e,s,r){let i=0,o="",a="",n="",l="",d=0,h=0;function u(e){o=t[e],a=t[e-1],n=t[e+1]}function m(e){x.length<h+1&&x.push([e]),x[h][x[h].length-1]!==e&&x[h].push(e)}function c(){if(g>d||d>C)return++d,void(l="");f.columnTypes||(!isNaN(parseFloat(l))&&isFinite(l)?(l=parseFloat(l),m("number")):isNaN(Date.parse(l))?m("string"):(l=l.replace(/\//g,"-"),m("date"))),p.length<h+1&&p.push([]),s||(p[h][e]=l),l="",++h,++d}if(t.trim().length&&"#"!==t.trim()[0]){for(;i<t.length;i++)if(u(i),'"'===o)for(u(++i);i<t.length&&('"'!==o||'"'===a||'"'===n);)('"'!==o||'"'===o&&'"'!==a)&&(l+=o),u(++i);else r&&r[o]?r[o](o,l)&&c():o===v?c():l+=o;c()}}(i[o],o-s-e);f.columnTypes&&0!==f.columnTypes.length||!x.length||!x[0].length||"date"!==x[0][1]||f.dateFormat||(f.dateFormat=function(e,t){const s="YYYY/mm/dd",r=[],i=[];let o,a=[],n,l=0,d=!1,h;for((!t||t>e.length)&&(t=e.length);l<t;l++)if(void 0!==e[l]&&e[l]&&e[l].length)for(o=e[l].trim().replace(/\//g," ").replace(/\-/g," ").replace(/\./g," ").split(" "),a=["","",""],h=0;h<o.length;h++)h<a.length&&(o[h]=parseInt(o[h],10),o[h]&&(i[h]=(!i[h]||i[h]<o[h]?o:i)[h],void 0!==r[h]?r[h]!==o[h]&&(r[h]=!1):r[h]=o[h],31<o[h]?o[h]<100?a[h]="YY":a[h]="YYYY":12<o[h]&&o[h]<=31?(a[h]="dd",d=!0):a[h].length||(a[h]="mm")));if(d){for(h=0;h<r.length;h++)!1!==r[h]?12<i[h]&&"YY"!==a[h]&&"YYYY"!==a[h]&&(a[h]="YY"):12<i[h]&&"mm"===a[h]&&(a[h]="dd");return(3===a.length&&"dd"===a[1]&&"dd"===a[2]&&(a[2]="YY"),n=a.join("/"),(f.dateFormats||u.dateFormats)[n])?n:(fireEvent("deduceDateFailed"),s)}return s}(p[0])),this.dataFound()}return p}parseTable(){const t=this.options,o=this.columns||[],a=t.startRow||0,s=t.endRow||Number.MAX_VALUE,n=t.startColumn||0,l=t.endColumn||Number.MAX_VALUE;if(t.table){let e=t.table;"string"==typeof e&&(e=doc.getElementById(e)),[].forEach.call(e.getElementsByTagName("tr"),(e,i)=>{i>=a&&i<=s&&[].forEach.call(e.children,(e,t)=>{const s=o[t-n];let r=1;if(("TD"===e.tagName||"TH"===e.tagName)&&t>=n&&t<=l)for(o[t-n]||(o[t-n]=[]),o[t-n][i-a]=e.innerHTML;i-a>=r&&void 0===s[i-a-r];)s[i-a-r]=null,r++})}),this.dataFound()}return o}fetchLiveData(){const a=this,n=this.chart,l=this.options,d=3,h=l.enablePolling,t=merge(l);let u=0,m=1e3*(l.dataRefreshRate||2);return!!hasURLOption(l)&&(m<1e3&&(m=1e3),delete l.csvURL,delete l.rowsURL,delete l.columnsURL,function i(o){function e(e,t,s){if(e&&/^(http|\/|\.\/|\.\.\/)/.test(e))return o&&(clearTimeout(a.liveDataTimeout),n.liveDataURL=e),ajax({url:e,dataType:s||"json",success:function(e){n&&n.series&&t(e),r()},error:function(e,t){return++u<d&&r(),l.error&&l.error(t,e)}}),1;function r(){h&&n.liveDataURL===e&&(a.liveDataTimeout=setTimeout(i,m))}e&&l.error&&l.error("Invalid URL")}e(t.csvURL,function(e){n.update({data:{csv:e}})},"text")||e(t.rowsURL,function(e){n.update({data:{rows:e}})})||e(t.columnsURL,function(e){n.update({data:{columns:e}})})}(!0),hasURLOption(l))}parseGoogleSpreadsheet(){const r=this,i=this.options,o=i.googleSpreadsheetKey,a=this.chart,n=Math.max(1e3*(i.dataRefreshRate||2),4e3),l=()=>{if(i.googleSpreadsheetRange)return i.googleSpreadsheetRange;var e="ABCDEFGHIJKLMNOPQRSTUVWXYZ",t=(e.charAt(i.startColumn||0)||"A")+((i.startRow||0)+1);let s=e.charAt(pick(i.endColumn,-1))||"ZZ";return defined(i.endRow)&&(s+=i.endRow+1),t+":"+s};return o&&(delete i.googleSpreadsheetKey,function t(s){var e=["https://sheets.googleapis.com/v4/spreadsheets",o,"values",l(),"?alt=json&majorDimension=COLUMNS&valueRenderOption=UNFORMATTED_VALUE&dateTimeRenderOption=FORMATTED_STRING&key="+i.googleAPIKey].join("/");ajax({url:e,dataType:"json",success:function(e){s(e),i.enablePolling&&(r.liveDataTimeout=setTimeout(function(){t(s)},n))},error:function(e,t){return i.error&&i.error(t,e)}})}(function(e){const t=e.values;if(!t||0===t.length)return!1;const s=t.reduce((e,t)=>Math.max(e,t.length),0);t.forEach(t=>{for(let e=0;e<s;e++)void 0===t[e]&&(t[e]=null)}),a&&a.series?a.update({data:{columns:t}}):(r.columns=t,r.dataFound())})),!1}trim(e,t){return"string"==typeof e&&(e=e.replace(/^\s+|\s+$/g,""),t&&/[\d\s]+/.test(e)&&(e=e.replace(/\s/g,"")),this.decimalRegex&&(e=e.replace(this.decimalRegex,"$1.$2"))),e}parseTypes(){var e=this.columns||[];let t=e.length;for(;t--;)this.parseColumn(e[t],t)}parseColumn(e,t){const s=this.rawColumns,r=this.columns,i=this.firstRowAsNames,o=-1!==this.valueCount.xColumns.indexOf(t),a=[],n=this.chartOptions,l=this.options.columnTypes||[],d=l[t],h=o&&n&&n.xAxis&&"category"===splat(n.xAxis)[0].type||"string"===d,u=defined(e.name);let m=e.length,c,p,f,g,C,x,v;for(s[t]||(s[t]=[]);m--;)c=a[m]||e[m],f=this.trim(c),g=this.trim(c,!0),p=parseFloat(g),void 0===s[t][m]&&(s[t][m]=f),h||0===m&&i&&!u?e[m]=""+f:+g===p?(31536e6<(e[m]=p)&&"float"!==d?e.isDatetime=!0:e.isNumeric=!0,void 0!==e[m+1]&&(v=p>e[m+1])):(f&&f.length&&(C=this.parseDate(c)),o&&isNumber(C)&&"float"!==d?(a[m]=c,e[m]=C,e.isDatetime=!0,void 0!==e[m+1]&&((x=C>e[m+1])!==v&&void 0!==v&&(this.alternativeFormat?(this.dateFormat=this.alternativeFormat,m=e.length,this.alternativeFormat=this.dateFormats[this.dateFormat].alternative):e.unsorted=!0),v=x)):(e[m]=""===f?null:f,0!==m&&(e.isDatetime||e.isNumeric)&&(e.mixed=!0)));if(o&&e.mixed&&(r[t]=s[t]),o&&v&&this.options.sort)for(t=0;t<r.length;t++)r[t].reverse(),i&&r[t].unshift(r[t].pop())}parseDate(e){const t=this.options.parseDate;let s,r,i,o=this.options.dateFormat||this.dateFormat,a;if(t)s=t(e);else if("string"==typeof e){if(o)i=(i=this.dateFormats[o])||this.dateFormats["YYYY/mm/dd"],(a=e.match(i.regex))&&(s=i.parser(a));else for(r in this.dateFormats)if(i=this.dateFormats[r],a=e.match(i.regex)){this.dateFormat=o=r,this.alternativeFormat=i.alternative,s=i.parser(a);break}a||(e.match(/:.+(GMT|UTC|[Z+\-])/)&&(e=e.replace(/\s*(?:GMT|UTC)?([+\-])(\d\d)(\d\d)$/,"$1$2:$3").replace(/(?:\s+|GMT|UTC)([+\-])/,"$1").replace(/(\d)\s*(?:GMT|UTC|Z)$/,"$1+00:00")),"object"==typeof(a=Date.parse(e))&&null!==a&&a.getTime?s=a.getTime()-6e4*a.getTimezoneOffset():isNumber(a)&&(s=a-6e4*new Date(a).getTimezoneOffset()))}return s}getData(){if(this.columns)return this.rowsToColumns(this.columns).slice(1)}parsed(){if(this.options.parsed)return this.options.parsed.call(this,this.columns)}complete(){const e=this.columns,t=this.options,s=[];let r,i,o,a,n,l,d,h,u,m,c,p;if(e.length,t.complete||t.afterComplete){if(this.firstRowAsNames)for(a=0;a<e.length;a++){const f=e[a];defined(f.name)||(f.name=pick(f.shift(),"").toString())}for(i=[],m=getFreeIndexes(e.length,this.valueCount.seriesBuilders),d=0;d<this.valueCount.seriesBuilders.length;d++)(u=this.valueCount.seriesBuilders[d]).populateColumns(m)&&s.push(u);for(;0<m.length;){for((u=new SeriesBuilder).addColumnReader(0,"x"),-1!==(p=m.indexOf(0))&&m.splice(p,1),a=0;a<this.valueCount.global;a++)u.addColumnReader(void 0,this.valueCount.globalPointArrayMap[a]);u.populateColumns(m)&&s.push(u)}if(0<s.length&&0<s[0].readers.length&&void 0!==(c=e[s[0].readers[0].columnIndex])&&(c.isDatetime?r="datetime":c.isNumeric||(r="category")),"category"===r)for(d=0;d<s.length;d++)for(u=s[d],l=0;l<u.readers.length;l++)"x"===u.readers[l].configName&&(u.readers[l].configName="name");for(d=0;d<s.length;d++){for(u=s[d],o=[],n=0;n<e[0].length;n++)o[n]=u.read(e,n);i[d]={data:o},u.name&&(i[d].name=u.name),"category"===r&&(i[d].turboThreshold=0)}h={series:i},r&&(h.xAxis={type:r},"category"===r&&(h.xAxis.uniqueNames=!1)),t.complete&&t.complete(h),t.afterComplete&&t.afterComplete(h)}}update(e,t){const s=this.chart,r=s.options;e&&(e.afterComplete=function(e){e&&(e.xAxis&&s.xAxis[0]&&e.xAxis.type===s.xAxis[0].options.type&&delete e.xAxis,s.update(e,t,!0))},merge(!0,r.data,e),r.data&&r.data.googleSpreadsheetKey&&!e.columns&&delete r.data.columns,this.init(r.data))}}addEvent(Chart,"init",function(e){const r=this,i=e.args[1],t=getOptions().data;let o=e.args[0]||{};var s;(t||o&&o.data)&&!r.hasDataDef&&(r.hasDataDef=!0,s=merge(t,o.data),r.data=new Data(extend(s,{afterComplete:function(e){let t,s;if(Object.hasOwnProperty.call(o,"series"))if("object"==typeof o.series)for(t=Math.max(o.series.length,e&&e.series?e.series.length:0);t--;)s=o.series[t]||{},o.series[t]=merge(s,e&&e.series?e.series[t]:{});else delete o.series;o=merge(e,o),r.init(o,i)}}),o,r),e.preventDefault())});class SeriesBuilder{constructor(){this.readers=[],this.pointIsArray=!0}populateColumns(t){let s=!0;return this.readers.forEach(e=>{void 0===e.columnIndex&&(e.columnIndex=t.shift())}),this.readers.forEach(e=>{void 0===e.columnIndex&&(s=!1)}),s}read(s,r){const i=this.pointIsArray,o=i?[]:{};if(this.readers.forEach(e=>{var t=s[e.columnIndex][r];i?o.push(t):0<e.configName.indexOf(".")?Point.prototype.setNestedProperty(o,t,e.configName):o[e.configName]=t}),void 0===this.name&&2<=this.readers.length){const t=[];this.readers.forEach(function(e){"x"!==e.configName&&"name"!==e.configName&&"y"!==e.configName||void 0!==e.columnIndex&&t.push(e.columnIndex)}),2<=t.length&&(t.shift(),t.sort(function(e,t){return e-t})),this.name=s[pick(t.shift(),0)].name}return o}addColumnReader(e,t){this.readers.push({columnIndex:e,configName:t}),"x"!==t&&"y"!==t&&void 0!==t&&(this.pointIsArray=!1)}getReferencedColumnIndexes(){const e=[];let t,s;for(t=0;t<this.readers.length;t+=1)void 0!==(s=this.readers[t]).columnIndex&&e.push(s.columnIndex);return e}hasReader(e){let t;for(t=0;t<this.readers.length;t+=1)if(this.readers[t].configName===e)return!0}}export default Data;